1000 ;
1001 ; The fine scroll macro library and support
1002 ;   subroutines.  They are heavily interdependent
1003 ;   so must always be .INCLUDEd together
1004 ;
1005 XDIM .BYTE 0
1006 YDIM .BYTE 0
1007 SCRBAS .WORD 0
1008 CSRBAS .WORD 0
1009 SDSPL .WORD 0
1010 SHSROL .BYTE 0
1011 SVSROL .BYTE 0
1012 HSPEED .BYTE 0
1013 VSPEED .BYTE 0
1014 X0LIM .BYTE 0
1015 Y0LIM .BYTE 0
1016 LINES .BYTE 0
1017 JMPBYT .BYTE 0
1018 RVBIV .WORD 0
1019 XLOC .BYTE 0
1020 YLOC .BYTE 0
1021 CWIDE .BYTE 0
1022 CHIGH .BYTE 0
1023 MLINES .BYTE 0
1024 SRBYTW .BYTE 0
1025 DIR .BYTE 0
1026 HCOUNT .BYTE 0
1027 VCOUNT .BYTE 0
1028 SCROLL .BYTE 0
1029 MODE .BYTE 0
1030 OLDVBV .WORD 0  ; Will hold previous vblank vector
1031 VVBLKD = $0224  ; Deferred vblank vector
1032 SETVBV = $E45C  ; OS routine to set vblank vector
1033 ;
1034     .MACRO SCRDIM 
1035      PLDA  %1
1036     TAX 
1037     ORA #$70
1038     STA JMPBYT
1039     DEX 
1040     DEX 
1041     STX MODE
1042      POKE  XDIM,%2
1043      POKE  YDIM,%3
1044      VPOKE  SCRBAS,%5
1045      VPOKE  SDSPL,%4
1046     JSR QQDSRL
1047     .ENDM 
1048     .MACRO SETXY 
1049      POKE  XLOC,%1
1050      POKE  YLOC,%2
1051     JSR QQSXY
1052     .ENDM 
1053     .MACRO STOPSCROLL 
1054     LDX OLDVBV+1
1055     LDY OLDVBV
1056     LDA #7
1057     JSR SETVBV
1058     .ENDM 
1059 QQCWID .BYTE 3,3,3,3,7,7
1060 QQCHIG .BYTE 7,9,7,15,7,15
1061 QQMLIN .BYTE 20,16,20,10,20,10
1062 QQDSRL
1063      DPOKE  CSRBAS,SCRBAS
1064     LDX MODE
1065     LDA QQCWID,X
1066     STA CWIDE
1067     LDA QQCHIG,X
1068     STA CHIGH
1069     LDA QQMLIN,X
1070     STA MLINES
1071     LDA #0
1072     STA XLOC
1073     STA YLOC
1074     STA VSPEED
1075     STA HSPEED
1076     LDA #15
1077     STA SCROLL
1078     LDA #0
1079     STA SHSROL
1080     STA SVSROL
1081     LDA CWIDE
1082     TAX 
1083     LDA #160
1084     CPX #7
1085     BNE QQSL2
1086     LSR A
1087 QQSL2
1088     LSR A
1089     LSR A
1090     STA SRBYTW
1091     LDA XDIM
1092     SEC 
1093     SBC SRBYTW
1094     STA X0LIM
1095     DEC X0LIM
1096     LDA YDIM
1097     SEC 
1098     SBC MLINES
1099     STA Y0LIM
1100     DEC Y0LIM
1101     LDA MLINES
1102     ASL A
1103     CLC 
1104     ADC MLINES
1105     STA LINES
1106     INC LINES
1107     INC LINES
1108     INC LINES
1109 ; WRITE BEGINING & END OF D LIST
1110      DPOKE  212,SDSPL
1111     LDA #$70
1112     LDY #0
1113     STA (212),Y
1114     INY 
1115     STA (212),Y
1116     INY 
1117     STA (212),Y
1118     LDY LINES
1119     INY 
1120     INY 
1121     INY 
1122     LDA #66
1123     STA (212),Y
1124     INY 
1125     LDA 660
1126     STA (212),Y
1127     INY 
1128     LDA 661
1129     STA (212),Y
1130     LDA #2
1131     INY 
1132     STA (212),Y
1133     INY 
1134     STA (212),Y
1135     INY 
1136     STA (212),Y
1137     LDA #65
1138     INY 
1139     STA (212),Y
1140     LDA SDSPL
1141     INY 
1142     STA (212),Y
1143     LDA SDSPL+1
1144     INY 
1145     STA (212),Y
1146      DPOKE  RVBIV,548
1147      DPOKE  OLDVBV,VVBLKD ; Save old vblank vector
1148     LDY # <QQAUTS
1149     LDX # >QQAUTS
1150     LDA #7
1151     JSR SETVBV  ; SETVBV
1152     LDA #2
1153     STA 540
1154 QQSL3
1155     LDA 540
1156     BNE QQSL3
1157      DPOKE  560,SDSPL
1158     LDA #4
1159     STA 703
1160     RTS 
1161 QQAUTS
1162 ; SAVE 212 & 204 ON STACK
1163     CLD 
1164     LDA 212
1165     PHA 
1166     LDA 212+1
1167     PHA 
1168     LDA 204
1169     PHA 
1170     LDA 204+1
1171     PHA 
1172      DPOKE  212,CSRBAS
1173      DPOKE  204,SDSPL
1174     LDY #3
1175 QQTL1
1176     LDA JMPBYT
1177     STA (204),Y
1178     INY 
1179     LDA 212
1180     STA (204),Y
1181     INY 
1182     LDA 212+1
1183     STA (204),Y
1184 ; ADD XDIM TO 212
1185     CLC 
1186     LDA 212
1187     ADC XDIM
1188     STA 212
1189     LDA 212+1
1190     ADC #0
1191     STA 212+1
1192     INY 
1193     CPY LINES
1194     BNE QQTL1
1195 ; WRITE LAST MODE LINE
1196     LDA JMPBYT
1197     AND #87
1198     STA (204),Y
1199     INY 
1200     LDA 212
1201     STA (204),Y
1202     INY 
1203     LDA 212+1
1204     STA (204),Y
1205 ; WRITE SHADOWS
1206     LDA SHSROL
1207     STA $D404   ; HSCROL
1208     LDA SVSROL
1209     STA $D405
1210     PLA 
1211     STA 204+1
1212     PLA 
1213     STA 204
1214     PLA 
1215     STA 212+1
1216     PLA 
1217     STA 212
1218     LDA SCROLL
1219     STA DIR
1220     LSR DIR
1221     BCS QQTNU   ; NO UPWARD SCROL
1222     INC VCOUNT
1223     LDA VSPEED
1224     CMP VCOUNT
1225     BCS QQTNU
1226     LDA #0
1227     STA VCOUNT
1228     DEC SVSROL
1229     BPL QQTNU
1230     LDA YLOC
1231     BNE QQTASN
1232     LDA #0
1233     STA SVSROL
1234     BEQ QQTNU
1235 QQTASN
1236     LDA CHIGH
1237     STA SVSROL
1238     DEC YLOC
1239     SEC 
1240     LDA CSRBAS
1241     SBC XDIM
1242     STA CSRBAS
1243     BCS QQTNU
1244     DEC CSRBAS+1
1245 QQTNU
1246 ; DOWN ?
1247     LSR DIR
1248     BCS QQTNV
1249     INC VCOUNT
1250     LDA VSPEED
1251     CMP VCOUNT
1252     BCS QQTNV
1253     LDA #0
1254     STA VCOUNT
1255     INC SVSROL
1256     LDA CHIGH
1257     CMP SVSROL
1258     BCS QQTNV
1259 ; CHECK LIMIT
1260     LDA YLOC
1261     CMP Y0LIM
1262     BNE QQTASN2
1263     LDA CHIGH
1264     STA SVSROL
1265     BNE QQTNV
1266 QQTASN2
1267     LDA #0
1268     STA SVSROL
1269     INC YLOC
1270     CLC 
1271     LDA CSRBAS
1272     ADC XDIM
1273     STA CSRBAS
1274     BCC QQTNV
1275     INC CSRBAS+1
1276 QQTNV
1277 ; LEFT?
1278     LSR DIR
1279     BCS QQTNL
1280     INC HCOUNT
1281     LDA HSPEED
1282     CMP HCOUNT
1283     BCS QQTNL
1284     LDA #0
1285     STA HCOUNT
1286     INC SHSROL
1287     LDA CWIDE
1288     CMP SHSROL
1289     BCS QQTNL
1290 ; CHECK LIMIT
1291     LDA XLOC
1292     BNE QQTASN3
1293     LDA CWIDE
1294     STA SHSROL
1295     BNE QQTNL
1296 QQTASN3
1297     LDA #0
1298     STA SHSROL
1299     DEC XLOC
1300     DEC CSRBAS
1301     LDA #$FF
1302     CMP CSRBAS
1303     BNE QQTNL
1304     DEC CSRBAS+1
1305 QQTNL
1306 ; RIGHT ?
1307     LSR DIR
1308     BCS QQTNR
1309     INC HCOUNT
1310     LDA HSPEED
1311     CMP HCOUNT
1312     BCS QQTNR
1313     LDA #0
1314     STA HCOUNT
1315     DEC SHSROL
1316     BPL QQTNR
1317 ; CHECK LIMIT
1318     LDA XLOC
1319     CMP X0LIM
1320     BNE QQTASN4
1321     LDA #0
1322     STA SHSROL
1323     BEQ QQTNR
1324 QQTASN4
1325     LDA CWIDE
1326     STA SHSROL
1327     INC XLOC
1328     INC CSRBAS
1329     BCC QQTNR
1330     INC CSRBAS+1
1331 QQTNR
1332     JMP (RVBIV)
1333 QQSXY
1334     LDA X0LIM
1335     CMP XLOC
1336      BGT  QQSX1
1337     STA XLOC
1338 QQSX1
1339     LDA Y0LIM
1340     CMP YLOC
1341      BGT  QQSX2
1342     STA YLOC
1343 QQSX2
1344      DPOKE  CSRBAS,SCRBAS
1345     LDY YLOC
1346     BEQ QQSXL6
1347 QQSXL4
1348     CLC 
1349     LDA CSRBAS
1350     ADC XDIM
1351     STA CSRBAS
1352     BCC QQSXL5
1353     INC CSRBAS+1
1354 QQSXL5
1355     DEY 
1356     BNE QQSXL4
1357 QQSXL6
1358 ; ADD IN XLOC
1359     CLC 
1360     LDA CSRBAS
1361     ADC XLOC
1362     STA CSRBAS
1363     BCC QQSXL7
1364     INC CSRBAS+1
1365 QQSXL7
1366 ; CLEAR SHADOWS
1367     LDA #0
1368     STA SHSROL
1369     STA SVSROL
1370     JMP (OLDVBV) ; Exit through old vertical blank vector.
